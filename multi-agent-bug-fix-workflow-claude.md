# 複数エージェントによるバグ修正ワークフロー

## 概要

このドキュメントは、Claude Codeが複数のエージェントを使用してバグ修正を実行するためのガイドです。各エージェントは特定の役割を持ち、協調してバグを解決します。

## ワークフローの構成

### エージェントの役割

1. **調査エージェント** (Opus) - バグの原因を分析し、修正方法を提案
2. **実装エージェント** (Sonnet) - 提案された修正を実装
3. **レビューエージェント** (Opus) - 実装内容をレビューし、品質を保証

## 実行手順

### Phase 0: 準備とクリーンアップ

1. backupディレクトリを作成する
2. 既存の成果物ファイルがあれば、タイムスタンプ付きでbackupディレクトリに移動する：
   - bug-investigation-report.md
   - code-review-report.md

### Phase 1: バグ調査

1. mcp__ccm__claude_codeツールを使用して調査エージェント（Opus）を起動する
2. プロンプトには以下を含める：
   - ユーザーから提供されたバグの詳細
   - 調査手順（コード読み込み、原因特定、影響分析、修正提案）
   - bug-investigation-report.mdへの出力指示

3. 出力形式を明確に指定する：
   ```
   # バグ調査レポート
   ## 問題の概要
   ## 原因の詳細
   ## 影響を受けるファイルと関数
   ## 推奨される修正方法
   ## 具体的な修正箇所とコード例
   ```

### Phase 2: 調査完了の確認

1. 5分待機する
2. mcp__ccm__get_claude_resultで結果を確認する
3. 完了していない場合は、さらに2分待機して再確認する
4. bug-investigation-report.mdが作成されているか確認する

### Phase 3: 修正の実装

1. mcp__ccm__claude_codeツールを使用して実装エージェント（Sonnet）を起動する
2. セッションIDを必ず保存する（後で再利用するため）
3. プロンプトには以下を含める：
   - bug-investigation-report.mdを読む指示
   - 具体的な修正の実装指示
   - ビルドコマンドの実行指示
   - 実装完了の報告形式

### Phase 4: コードレビュー

1. 実装完了まで3分待機する
2. mcp__ccm__claude_codeツールを使用してレビューエージェント（Opus）を起動する
3. セッションIDを必ず保存する（再レビューで再利用するため）
4. code-review-report.mdへの出力形式を明確に指定する：
   - 1行目: COMPLETED または INCOMPLETE
   - 2行目以降: INCOMPLETEの場合のみ、具体的な指摘事項

### Phase 5: 修正サイクル

1. レビュー完了まで2分待機する
2. code-review-report.mdの1行目を確認する
3. INCOMPLETEの場合：
   - 実装エージェントのセッションを再開（保存したセッションIDを使用）
   - 指摘事項を修正するよう指示
   - 修正完了まで2分待機
   - レビューエージェントのセッションを再開（保存したセッションIDを使用）
   - 再レビューを指示
4. COMPLETEDになるまで最大5回繰り返す

### 完了確認

レビューステータスがCOMPLETEDの場合：
- バグ修正が完了
- 成果物を確認（調査レポート、レビューレポート、修正されたコード）

レビューステータスがINCOMPLETEのまま5回を超えた場合：
- 手動介入が必要であることを報告

## 重要な注意事項

### セッション管理

- **調査エージェント**: 新規セッション（使い捨て）
- **実装エージェント**: セッションIDを保持し、修正時に再利用
- **レビューエージェント**: セッションIDを保持し、再レビュー時に再利用

### ファイル形式

- code-review-report.mdの1行目は必ず「COMPLETED」または「INCOMPLETE」
- これがレビューサイクル継続の判断基準となる

### 待機時間の目安

- 調査エージェント: 5分（初回）、2分（再確認）
- 実装エージェント: 3分
- レビューエージェント: 2分
- 修正サイクル: 各2分

### エラー処理

- ファイルが見つからない場合は適切に報告する
- エージェントがタイムアウトした場合は再試行を検討する
- プロセスが異常終了した場合はクリーンアップを実行する

## 成功事例

### LockServiceバグ修正

1. **問題**: ロックファイル作成時のディレクトリ不在エラー
2. **調査**: acquireFileLockメソッドでディレクトリ作成処理が不足と判明
3. **実装**: fs.mkdir({ recursive: true })による親ディレクトリ作成を追加
4. **初回レビュー**: INCOMPLETE（コメント国際化、ログ出力、定数化の指摘）
5. **修正**: 実装エージェントのセッション再開で指摘事項を対応
6. **再レビュー**: レビューエージェントのセッション再開でCOMPLETED確認

## まとめ

このワークフローにより、バグの調査から修正、品質保証までを体系的に実行できます。各エージェントが専門的な役割を果たし、セッションの再利用により効率的な修正サイクルを実現します。